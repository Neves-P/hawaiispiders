---
title: "Sensitivity analysis"
output: html_notebook
---

Here I present the sensitivity of the model to alternate data sets, each corresponding to a specific interpretation of the phylogenetic data or model parameters.

I compiled 12 alternate data sets from the same spider phylogenies. All data sets and the files needed to produce them are included as data objects on this `R` package. For the time being, this package is private and access to the raw data is only possible via invite. 


The following table describes the differences between each data set.

## Scenario descriptions
|Scenario|Island Age|Favour cladogenesis|Favour MaxAge|
|:------:|:--------:|:-----------------:|:-----------:|
| y_c_max|   1.2My  |        Yes        |     Yes     |
| y_c_min|   1.2My  |        Yes        |     MinAge  |
| y_c_no |   1.2My  |        Yes        |     Never   |
| o_c_max|   2.4My  |        Yes        |     Yes     |
| o_c_min|   2.4My  |        Yes        |     MinAge  |
| o_c_no |   2.4My  |        Yes        |     Never   |
| y_m_max|   1.2My  |        No         |     Yes     |
| y_m_min|   1.2My  |        No         |     MinAge  |
| y_m_no |   1.2My  |        No         |     Never   |
| o_m_max|   2.4My  |        No         |     Yes     |
| o_m_min|   2.4My  |        No         |     MinAge  |
| o_m_no |   2.4My  |        No         |     Never   |

In scenarios favouring MaxAge the colonisation time is always assumed to be an upper limit, rather than a precise age, even when a precise age can be estimated from the data. While some information is lost in this process, the upside lies in accounting for possible uncertainty when 
A MinAge functions as a lower boundary for uncertain colonisation times. This lower limit corresponds to the earliest split between two populations of the same species 
MinAge favouring in the MaxAge column implies that MaxAgeMinAges are used when a min age is available and the precise colonisation time is available too.
Not (never) favouring MaxAge means MinAges are used only **iff** the precise colonisation age is unknown and a min age is available. These are the "\_no" scenarios, which are arguably the most realistic ones from an empirical point of view.

Broadly speaking, the data consists of mainly singleton endemic species which colonised the island early. In many cases the colonisation time predates the island age. On scenarios favouring cladogenesis, 33 independent clades are present, while the number increases to 35 on scenarios favouring colonisation. There are 37 species in total. 7 of all species are known to be present as nonendemics on the island, but have not been sampled in the phylogeny, hence their colonisation time is unknown.

```{r Plot, echo=FALSE}
data("y_c_no", package = "hawaiispiders")
DAISIE::DAISIE_plot_island(y_c_no)

data("o_c_no", package = "hawaiispiders")
DAISIE::DAISIE_plot_island(o_c_no)

data("y_m_no", package = "hawaiispiders")
DAISIE::DAISIE_plot_island(y_m_no)

data("o_m_no", package = "hawaiispiders")
DAISIE::DAISIE_plot_island(o_m_no)
```



## Model fitting

Seven different DAISIE models were fit to each of the data sets. Only constant rate models were used for these analyses.
Fit models are as follows:

* Constant rate diversity dependent model
* Constant rate diversity independent model
* Constant rate diversity dependent model with anagenesis rate fixed to 0
* Constant rate diversity independent model with anagenesis rate fixed to 0

## Sensitivity

After having fit a collection of DAISIE models, senstivity analysis was performed to assess the influence of varying scenarios on the selection of the best model and model rank overall.



Table 1. BIC for each model and dataset. Cells in red correspond to the lowest BIC value of a given dataset, and hence the preferred model. 
```{r Sensitivity MaxAge, echo=FALSE}
rate_names <- c(
  "rate_y_max",
  "rate_y_min",
  "rate_y_no",
  "rate_o_max",
  "rate_o_min",
  "rate_o_no"
)

scenarios <- c(
  "y_c_max",
  "y_m_max",
  "y_c_min",
  "y_m_min",
  "y_c_no",
  "y_m_no",
  "o_c_max",
  "o_m_max",
  "o_c_min",
  "o_m_min",
  "o_c_no",
  "o_m_no"
)

rate_sens <- DAISIEutils::sensitivity(scenarios, full_output = TRUE)

# rate_model_rankings <- data.frame(lapply(rate_sens$model_selection_rank, "[", 1))
model_orders <- c("cr_di", "cr_dd", "cr_di_0laa", "cr_dd_0laa")
rate_model_rankings <- data.frame(
  "cr_di" = numeric(),
  "cr_dd" = numeric(),
  "cr_di_0laa" = numeric(),
  "cr_dd_0laa" = numeric()
)

for (scenario in seq_along(scenarios)) {
  for (model in model_orders) {
    rate_model_rankings[scenario, model] <- 
      rate_sens$model_selection_rank[[scenario]][[model]]
  }
}
rownames(rate_model_rankings) <- scenarios

rate_min_values <- apply(rate_model_rankings, 1, min)
rate_model_rankings %>% dplyr::mutate_all(~kableExtra::cell_spec(
  .x, color = ifelse(.x %in% rate_min_values, "red", "black"))) %>% 
  knitr::kable(escape = FALSE) %>% kableExtra::kable_styling()
```

```{r crdi results, echo=FALSE}
# best model results
best_model <- c(rep("cr_di", 10), "cr_dd_0laa", "cr_di")
row_names <- c()
cr_model_fits <- data.frame()
for (j in seq_along(rate_sens[[4]])) {
  cr_model_fits <- rbind(
    cr_model_fits, rate_sens[[4]][[j]][[best_model[j]]]
  )
}
rownames(cr_model_fits) <- names(rate_sens[[4]])

knitr::kable(cr_model_fits) %>% kableExtra::kable_styling()
```
